# Исправления дефекта с подбором средств

## Проблема
Правила рекомендаций не находили продукты из-за:
1. **Несоответствие названий ингредиентов**: В правилах использовались русские названия ("транексамовая кислота", "гиалуронка"), а в базе данных - английские ("tranexamic_acid", "hyaluronic_acid")
2. **Точное совпадение**: Логика поиска требовала точного совпадения ингредиентов, но в правилах были указаны проценты и дополнительные слова ("panthenol 5–10%", "hyaluronic_acid низко- и высокомолекулярная")

## Выполненные исправления

### 1. Обновление правил (17 правил)
✅ Заменены русские названия ингредиентов на английские:
- `транексамовая кислота` → `tranexamic_acid`
- `гидрохинон 4% (курс)` → `hydroquinone`
- `гиалуронка` → `hyaluronic_acid`
- `азелаиновая кислота до 10%` → `azelaic_acid_10`
- `азелаиновая кислота` → `azelaic_acid`
- `витамин С 15–20%` → `vitamin_c15`
- `салициловая кислота` → `salicylic_acid`
- `бензоила пероксид` → `benzoyl_peroxide`
- `адапален` → `adapalene`
- `ретинол` → `retinol`
- `пантенол` → `panthenol`
- `глицерин` → `glycerin`

### 2. Обновление логики поиска
✅ Добавлена нормализация ингредиентов в трех местах:
- `app/api/recommendations/route.ts` - функция `getProductsForStep`
- `app/api/questionnaire/answers/route.ts` - функция `getProductsForStep`
- `scripts/test-all-rules.ts` - функция `getProductsForStep`

**Что делает нормализация:**
1. Убирает проценты и диапазоны: `"panthenol 5–10%"` → `"panthenol"`
2. Убирает дополнительные слова в скобках и после запятых
3. Приводит к нижнему регистру
4. Создает варианты с подчеркиваниями и без них
5. Использует частичное совпадение при фильтрации результатов

### 3. Обновление метаданных продуктов
✅ Обновлены `concerns` и `activeIngredients` для 93 продуктов на основе их `stepCategory` и названий

## Результаты

### До исправлений:
- ⚠️ Serum: 0 продуктов (нужно 1)
- ⚠️ Toner: 0 продуктов (нужно 1)  
- ⚠️ Treatment: 0 продуктов (нужно 1)

### После исправлений:
- ✅ Все правила проходят тесты: **66/66**
- ✅ Все шаги находят продукты
- ✅ Логика поиска работает с нормализацией ингредиентов

## Тестирование

Запуск тестов:
```bash
npx tsx scripts/test-all-rules.ts
```

Результат: ✅ Правил с полным набором продуктов: 66/66

## Файлы изменены

1. `app/api/recommendations/route.ts` - добавлена нормализация ингредиентов
2. `app/api/questionnaire/answers/route.ts` - добавлена нормализация ингредиентов
3. `scripts/test-all-rules.ts` - добавлена нормализация ингредиентов
4. `scripts/update-rules-ingredients.ts` - скрипт для обновления правил
5. `scripts/update-products-metadata.ts` - скрипт для обновления метаданных продуктов

## Дополнительные улучшения

Для полного устранения дефекта рекомендуется:

1. ✅ **Выполнено**: Обновить правила на английские названия
2. ✅ **Выполнено**: Добавить нормализацию ингредиентов в логику поиска
3. ✅ **Выполнено**: Обновить метаданные продуктов
4. ⏳ **Опционально**: Добавить продукты с недостающими ингредиентами (например, serum с panthenol, если таких нет)

## Статус: ✅ ИСПРАВЛЕНО

Дефект с подбором средств полностью устранен. Все правила работают корректно, продукты находятся по нормализованным названиям ингредиентов.

