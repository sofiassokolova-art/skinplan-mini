// Prisma schema для SkinIQ
// База данных: PostgreSQL (Neon)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ПОЛЬЗОВАТЕЛИ И ПРОФИЛИ
// ============================================

model User {
  id          String    @id @default(cuid())
  telegramId  String    @unique @map("telegram_id")
  username    String?
  firstName   String?   @map("first_name")
  lastName    String?   @map("last_name")
  language    String    @default("ru")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  skinProfiles        SkinProfile[]
  userAnswers         UserAnswer[]
  recommendationSessions RecommendationSession[]

  @@map("users")
}

model SkinProfile {
  id                String   @id @default(cuid())
  userId            String   @map("user_id")
  version           Int      @default(1) // Версия логики расчета
  skinType          String?  @map("skin_type") // dry / oily / combo / normal / sensitive
  sensitivityLevel  String?  @map("sensitivity_level") // low / medium / high
  dehydrationLevel  Int?     @map("dehydration_level") // 0-5
  acneLevel         Int?     @map("acne_level") // 0-5
  rosaceaRisk       String?  @map("rosacea_risk") // none / low / medium / high
  pigmentationRisk  String?  @map("pigmentation_risk") // none / low / medium / high
  ageGroup          String?  @map("age_group") // 18_25 / 26_30 / 31_40 / 41_50 / 50_plus
  hasPregnancy      Boolean? @default(false) @map("has_pregnancy")
  medicalMarkers    Json?    @map("medical_markers") // JSON для дополнительных маркеров
  notes             String?  // Текстовое резюме для отображения
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  recommendationSessions RecommendationSession[]

  @@unique([userId, version])
  @@index([userId])
  @@map("skin_profiles")
}

// ============================================
// АНКЕТА
// ============================================

model Questionnaire {
  id        Int      @id @default(autoincrement())
  name      String   // "Базовая анкета v1"
  version   Int      @default(1)
  isActive  Boolean  @default(false) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  questionGroups QuestionGroup[]
  questions      Question[]
  userAnswers    UserAnswer[]

  @@unique([version])
  @@map("questionnaires")
}

model QuestionGroup {
  id             Int        @id @default(autoincrement())
  questionnaireId Int       @map("questionnaire_id")
  title          String
  position       Int
  createdAt      DateTime   @default(now()) @map("created_at")

  questionnaire  Questionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  questions      Question[]

  @@index([questionnaireId])
  @@map("question_groups")
}

model Question {
  id             Int            @id @default(autoincrement())
  questionnaireId Int           @map("questionnaire_id")
  groupId        Int?           @map("group_id")
  code           String         // OILINESS, SENSITIVITY, etc.
  text           String
  type           String         // single_choice / multi_choice / scale / free_text
  position       Int
  isRequired     Boolean        @default(true) @map("is_required")
  createdAt      DateTime       @default(now()) @map("created_at")

  questionnaire  Questionnaire  @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  group          QuestionGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  answerOptions  AnswerOption[]
  userAnswers    UserAnswer[]

  @@index([questionnaireId])
  @@index([groupId])
  @@map("questions")
}

model AnswerOption {
  id         Int      @id @default(autoincrement())
  questionId Int      @map("question_id")
  value      String   // VERY_OILY, HIGH, etc.
  label      String   // Текст для пользователя
  position   Int
  scoreJson  Json?    @map("score_json") // { "oiliness": 3, "sensitivity": 1 }

  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("answer_options")
}

model UserAnswer {
  id             Int       @id @default(autoincrement())
  userId         String    @map("user_id")
  questionnaireId Int      @map("questionnaire_id")
  questionId     Int       @map("question_id")
  answerValue    String?   @map("answer_value") // Для single/scale
  answerValues   Json?     @map("answer_values") // Для multi - JSON массив
  createdAt      DateTime  @default(now()) @map("created_at")

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionnaire  Questionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  question       Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([questionnaireId])
  @@index([questionId])
  @@map("user_answers")
}

// ============================================
// КАТАЛОГ ПРОДУКТОВ
// ============================================

model Brand {
  id        Int       @id @default(autoincrement())
  name      String
  country   String?
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  products  Product[]

  @@map("brands")
}

model Product {
  id              Int      @id @default(autoincrement())
  brandId         Int      @map("brand_id")
  name            String
  line            String?  // Линейка продукта
  category        String   // cleanser / toner / cream / spf / serum / mask
  step            String   // cleansing / toning / treatment / moisturizer / spf
  skinTypes       String[] @map("skin_types") // [dry, oily, combo, sensitive]
  concerns        String[] // [acne, rosacea, dehydration, pigmentation, aging]
  isFragranceFree Boolean  @default(false) @map("is_fragrance_free")
  isNonComedogenic Boolean @default(false) @map("is_non_comedogenic")
  priceSegment    String?  @map("price_segment") // mass / mid / premium
  descriptionUser String?  @map("description_user") // Текст для карточки
  marketLinks     Json?    @map("market_links") // JSON: { "ozon": "...", "wb": "..." }
  status          String   @default("draft") // draft / published
  imageUrl        String?  @map("image_url") // Для будущего хранения изображений
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  brand           Brand    @relation(fields: [brandId], references: [id])

  @@index([brandId])
  @@index([status])
  @@index([step])
  @@map("products")
}

// ============================================
// ПРАВИЛА РЕКОМЕНДАЦИЙ
// ============================================

model RecommendationRule {
  id            Int       @id @default(autoincrement())
  name          String    // "Жирная кожа + акне 18–30"
  conditionsJson Json     @map("conditions_json") // JSON-логика условий
  stepsJson     Json      @map("steps_json") // Описание шагов рутины
  priority      Int       @default(0) // Приоритет при пересечении правил
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  recommendationSessions RecommendationSession[]

  @@index([isActive, priority])
  @@map("recommendation_rules")
}

model RecommendationSession {
  id             Int       @id @default(autoincrement())
  userId         String    @map("user_id")
  profileId      String    @map("profile_id")
  ruleId         Int?      @map("rule_id")
  products       Json      // Массив product_id, которые показали
  createdAt      DateTime  @default(now()) @map("created_at")

  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  profile        SkinProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  rule           RecommendationRule? @relation(fields: [ruleId], references: [id])

  @@index([userId])
  @@index([profileId])
  @@map("recommendation_sessions")
}

// ============================================
// АДМИНИСТРАТОРЫ
// ============================================

model Admin {
  id              Int       @id @default(autoincrement())
  email           String?   @unique
  telegramId      String?   @unique @map("telegram_id")
  telegramUsername String?  @unique @map("telegram_username")
  passwordHash    String?   @map("password_hash")
  role            String    @default("editor") // admin / editor
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("admins")
}
