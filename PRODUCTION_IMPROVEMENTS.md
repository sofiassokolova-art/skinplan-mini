# Улучшения для продакшена

## Критичные улучшения

### 1. Убрать console.log из production кода
**Проблема:** Много `console.log` в клиентском и серверном коде замедляет работу.

**Файлы для проверки:**
- `app/(miniapp)/plan/page.tsx` - много console.log
- `app/(miniapp)/profile/page.tsx` - console.warn/log
- Все API routes

**Решение:** 
- Использовать `logger` вместо `console.log` на сервере
- Условное логирование на клиенте: `if (process.env.NODE_ENV === 'development')`
- Или использовать отдельный logger для клиента

### 2. Оптимизация проверки кэша плана
**Проблема:** При каждом запросе проверяются предыдущие версии профиля, что может быть медленно.

**Текущая реализация:** Проверяет до 2 предыдущих версий последовательно.

**Решение:**
- Кэшировать результаты проверки на короткое время (1-2 минуты)
- Или хранить ссылку на актуальную версию плана в профиле пользователя

### 3. Обработка React Error #300
**Проблема:** В логах повторяются ошибки React #300 на странице `/quiz`.

**Причина:** Возможно условный рендеринг компонентов или неправильное использование хуков.

**Решение:**
- Проверить `app/(miniapp)/quiz/page.tsx` на условное использование хуков
- Убедиться, что все хуки вызываются в одинаковом порядке при каждом рендере

### 4. Валидация initData на сервере
**Проблема:** initData должен проверяться на подлинность перед использованием.

**Текущая реализация:** Проверяется только наличие, но не подпись.

**Решение:**
- Добавить проверку подписи Telegram initData
- Проверять срок действия initData
- Логировать подозрительные запросы

### 5. Timeout для долгих операций
**Проблема:** Генерация плана может занимать много времени, нет timeout.

**Решение:**
- Добавить timeout для генерации плана (например, 60 секунд)
- Показывать пользователю прогресс
- Отменять операцию при превышении времени

### 6. Обработка сетевых ошибок
**Проблема:** Нет явной обработки сетевых ошибок (offline, timeout).

**Решение:**
- Добавить обработку `navigator.onLine`
- Показывать сообщение при отсутствии интернета
- Retry логика для сетевых ошибок

## Важные улучшения

### 7. Мониторинг и алерты
**Решение:**
- Интеграция с Sentry для отслеживания ошибок
- Метрики производительности (Web Vitals)
- Алерты при росте ошибок

### 8. Оптимизация загрузки изображений
**Проблема:** Изображения продуктов могут быть большими.

**Решение:**
- Использовать Next.js Image с оптимизацией
- Lazy loading для изображений вне viewport
- WebP формат с fallback

### 9. Проверка обязательных переменных окружения
**Проблема:** При отсутствии переменных приложение может падать непредсказуемо.

**Решение:**
- Создать файл `lib/env-check.ts` для валидации env переменных при старте
- Показывать понятные ошибки при отсутствии обязательных переменных

### 10. Кэширование на клиенте
**Проблема:** Нет кэширования API ответов на клиенте.

**Решение:**
- Использовать React Query или SWR для кэширования
- Уменьшить количество повторных запросов к API

### 11. Сжатие ответов API
**Решение:**
- Включить gzip/brotli compression для API responses
- Особенно важно для больших JSON ответов (план, рекомендации)

### 12. Database connection pooling
**Проблема:** При большом количестве запросов могут быть проблемы с подключениями к БД.

**Решение:**
- Настроить connection pooling для Prisma
- Мониторить количество активных подключений

## Улучшения UX

### 13. Skeleton loaders вместо простых спиннеров
**Проблема:** Спиннеры не дают понимания, что загружается.

**Решение:**
- Добавить skeleton loaders для списков продуктов
- Skeleton для карточек плана

### 14. Оптимистичные обновления UI
**Проблема:** UI обновляется только после ответа сервера.

**Решение:**
- Обновлять UI сразу при действиях пользователя (добавление в избранное, корзину)
- Откатывать при ошибке

### 15. Debounce для поиска и фильтров
**Решение:**
- Debounce для поиска в админке
- Throttle для скролла

## Безопасность

### 16. CORS настройки
**Решение:**
- Явно настроить CORS headers
- Ограничить разрешенные origins

### 17. Content Security Policy
**Решение:**
- Добавить CSP headers
- Ограничить загрузку внешних ресурсов

### 18. Rate limiting для всех endpoints
**Текущая реализация:** Есть для некоторых endpoints.

**Улучшение:**
- Добавить базовый rate limiting для всех API endpoints
- Более строгие лимиты для публичных endpoints

## Производительность

### 19. Code splitting
**Решение:**
- Динамические импорты для тяжелых компонентов
- Lazy loading для страниц

### 20. Мемоизация вычислений
**Проблема:** Некоторые вычисления могут выполняться при каждом рендере.

**Решение:**
- Использовать `useMemo` для тяжелых вычислений
- `useCallback` для функций, передаваемых в дочерние компоненты

### 21. Валидация данных на клиенте
**Решение:**
- Валидация форм на клиенте перед отправкой
- Уменьшение количества запросов к серверу

## Мониторинг

### 22. Логирование производительности
**Решение:**
- Логировать медленные запросы (>1 секунда)
- Метрики времени генерации плана
- Отслеживать использование кэша

### 23. Health check endpoint
**Решение:**
- `/api/health` endpoint для проверки состояния сервиса
- Проверка БД, Redis, KV store

### 24. Метрики использования
**Решение:**
- Трекинг популярных продуктов
- Метрики завершения анкеты
- Конверсия в покупки

## Приоритеты

### P0 (Критично, сделать перед продом):
1. Убрать console.log из production
2. Валидация initData на сервере
3. Исправить React Error #300
4. Проверка обязательных env переменных

### P1 (Важно, сделать в первую неделю после пуска):
5. Мониторинг (Sentry)
6. Timeout для долгих операций
7. Обработка сетевых ошибок
8. Health check endpoint

### P2 (Желательно, сделать в течение месяца):
9. Оптимизация изображений
10. Кэширование на клиенте
11. Skeleton loaders
12. Оптимистичные обновления

