#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π Prisma –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

set -e

echo "üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π Prisma –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ"
echo "=========================================="
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è DATABASE_URL
if [ -z "$DATABASE_URL" ]; then
    echo "‚ùå DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    echo ""
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ DATABASE_URL –æ–¥–Ω–∏–º –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤:"
    echo "1. –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π: export DATABASE_URL='postgresql://...'"
    echo "2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Vercel CLI: vercel env pull .env.production"
    echo ""
    exit 1
fi

echo "‚úÖ DATABASE_URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π..."
npx prisma migrate status

echo ""
echo "üîÑ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
npx prisma migrate deploy

echo ""
echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü..."
npx prisma db execute --stdin --schema=prisma/schema.prisma <<< "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name LIKE 'question%' ORDER BY table_name;" 2>&1 | grep -E "question|table_name" || echo "–¢–∞–±–ª–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã"

echo ""
echo "üéâ –ì–æ—Ç–æ–≤–æ!"

