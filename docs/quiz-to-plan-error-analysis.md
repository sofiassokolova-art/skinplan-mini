# Анализ возможных ошибок: Отправка ответов → Отображение плана

## Обзор процесса

1. **Клиент (quiz/page.tsx)**: `submitAnswers()` → `api.submitAnswers()`
2. **API (questionnaire/answers/route.ts)**: Сохранение ответов → Создание профиля
3. **Клиент (quiz/page.tsx)**: `api.generatePlan()` 
4. **API (plan/generate/route.ts)**: Генерация плана → Сохранение в БД
5. **Клиент (quiz/page.tsx)**: Ожидание готовности плана → Редирект на `/plan`
6. **Клиент (plan/page.tsx)**: Загрузка плана → Отображение

---

## 1. Ошибки при отправке ответов (submitAnswers)

### 1.1 Ошибки валидации на клиенте

**Место**: `app/(miniapp)/quiz/page.tsx:1746-1800`

- ❌ **`questionnaire === null`**
  - Причина: Анкета не загружена
  - Обработка: `setError('Анкета не загружена')`, `setIsSubmitting(false)`, `return`
  - Последствия: Пользователь видит ошибку, лоадер скрывается

- ❌ **`Object.keys(answers).length === 0`**
  - Причина: Нет ответов для отправки
  - Обработка: `setError('Нет ответов для отправки')`, `setIsSubmitting(false)`, `return`
  - Последствия: Пользователь видит ошибку

### 1.2 Ошибки при подготовке данных

**Место**: `app/(miniapp)/quiz/page.tsx:2080-2144`

- ❌ **`initData === null`**
  - Причина: Telegram WebApp не инициализирован или `initData` недоступен
  - Обработка: `throw new Error('initData не доступен. Пожалуйста, обновите страницу.')`
  - Последствия: Ошибка попадает в catch блок, показывается пользователю

- ❌ **Ошибка при формировании `answerArray`**
  - Причина: Некорректная структура ответов
  - Обработка: Может привести к отправке некорректных данных на сервер
  - Последствия: Сервер вернет `400 Bad Request`

### 1.3 Ошибки при вызове API

**Место**: `app/(miniapp)/quiz/page.tsx:2144-2276`

- ❌ **Сетевая ошибка (network error)**
  - Причина: Потеря интернет-соединения, таймаут запроса
  - Обработка: Catch блок, логирование, `setError()`, `setIsSubmitting(false)`
  - Последствия: Пользователь видит ошибку, может повторить попытку

- ❌ **401 Unauthorized**
  - Причина: Недействительный или истекший `initData`
  - Обработка: Логирование, `setError('Ошибка авторизации')`, `setIsSubmitting(false)`
  - Последствия: Пользователю нужно обновить страницу

- ❌ **400 Bad Request**
  - Причина: Некорректные данные запроса
  - Обработка: Логирование, показ ошибки
  - Последствия: Пользователь видит ошибку

- ❌ **500 Internal Server Error**
  - Причина: Ошибка на сервере при обработке запроса
  - Обработка: Логирование, показ общей ошибки
  - Последствия: Пользователь видит ошибку, возможно нужно повторить попытку

- ❌ **Дубликат запроса (duplicate submission)**
  - Причина: Пользователь отправил ответы повторно в течение 5 секунд
  - Обработка: Проверка `isDuplicate`, показ сообщения или продолжение
  - Последствия: Возможна путаница в состоянии

### 1.4 Ошибки после отправки ответов

**Место**: `app/(miniapp)/quiz/page.tsx:2186-2218`

- ❌ **Профиль не создан (`!result?.profile?.id`)**
  - Причина: Сервер вернул успешный ответ, но без профиля
  - Обработка: 
    - Очистка флага `quiz_just_submitted`
    - `setError('Не удалось создать профиль. Пожалуйста, попробуйте еще раз.')`
    - `setIsSubmitting(false)`, `return`
  - Последствия: Пользователь видит ошибку, процесс останавливается

- ❌ **Ошибка очистки кэша профиля**
  - Причина: Ошибка при работе с `sessionStorage`
  - Обработка: Только логирование, не критично
  - Последствия: Старый кэш может остаться, но это не критично

---

## 2. Ошибки на сервере при сохранении ответов

### 2.1 Ошибки авторизации

**Место**: `app/api/questionnaire/answers/route.ts:93-111`

- ❌ **`initData === null`**
  - Причина: Отсутствует заголовок `X-Telegram-Init-Data`
  - Обработка: `ApiResponse.unauthorized('Missing Telegram initData')`
  - Последствия: Клиент получает 401, показывается ошибка

- ❌ **Недействительный `initData`**
  - Причина: `getUserIdFromInitData()` вернул `null`
  - Обработка: `ApiResponse.unauthorized('Invalid or expired initData')`
  - Последствия: Клиент получает 401

### 2.2 Ошибки валидации запроса

**Место**: `app/api/questionnaire/answers/route.ts:115-164`

- ❌ **Некорректное тело запроса**
  - Причина: Отсутствует `questionnaireId` или `answers` не массив
  - Обработка: `ApiResponse.badRequest('Invalid request body')`
  - Последствия: Клиент получает 400

- ❌ **Нет валидных ответов**
  - Причина: Все ответы имеют некорректный `questionId`
  - Обработка: `ApiResponse.badRequest('No valid answers provided')`
  - Последствия: Клиент получает 400

- ❌ **Анкета не найдена**
  - Причина: `questionnaireId` не существует в БД
  - Обработка: `ApiResponse.notFound('Questionnaire not found')`
  - Последствия: Клиент получает 404

### 2.3 Ошибки при сохранении в БД

**Место**: `app/api/questionnaire/answers/route.ts:250-400`

- ❌ **Ошибка транзакции Prisma**
  - Причина: Ошибка БД при сохранении ответов
  - Обработка: Транзакция откатывается, возвращается `500 Internal Server Error`
  - Последствия: Данные не сохраняются, клиент получает ошибку

- ❌ **Ошибка создания профиля**
  - Причина: Ошибка в `buildSkinProfileFromAnswers()` или сохранении профиля
  - Обработка: Транзакция откатывается, возвращается `500 Internal Server Error`
  - Последствия: Ответы не сохраняются, профиль не создается

- ❌ **Ошибка создания RecommendationSession**
  - Причина: Ошибка при создании сессии рекомендаций
  - Обработка: Транзакция откатывается, возвращается `500 Internal Server Error`
  - Последствия: Данные не сохраняются

### 2.4 Ошибки дубликата

**Место**: `app/api/questionnaire/answers/route.ts:206-229`

- ⚠️ **Дубликат запроса (профиль существует)**
  - Причина: Ответы отправлены менее чем 5 секунд назад и профиль существует
  - Обработка: Возвращается успешный ответ с `isDuplicate: true`
  - Последствия: Клиент считает запрос успешным, но данные не пересохраняются

---

## 3. Ошибки при генерации плана (api.generatePlan)

### 3.1 Ошибки на клиенте при вызове

**Место**: `app/(miniapp)/quiz/page.tsx:2600-2678`

- ❌ **Таймаут генерации (30 секунд)**
  - Причина: Генерация плана занимает больше 30 секунд
  - Обработка: `Promise.race()` с таймаутом, выбрасывается ошибка
  - Последствия: Ошибка попадает в catch, но редирект все равно происходит

- ❌ **Пустой результат генерации**
  - Причина: API вернул успешный ответ, но план пустой (`!hasPlan28 && !hasWeeks`)
  - Обработка: Выбрасывается ошибка `'Plan generation returned empty result'`
  - Последствия: Ошибка логируется, но редирект продолжается

- ❌ **Сетевая ошибка**
  - Причина: Потеря соединения, таймаут
  - Обработка: Catch блок, логирование, но редирект продолжается
  - Последствия: Пользователь редиректится на `/plan`, где план будет сгенерирован заново

- ❌ **500 Internal Server Error**
  - Причина: Ошибка на сервере при генерации
  - Обработка: Catch блок, логирование, редирект продолжается
  - Последствия: Пользователь редиректится на `/plan`, где план будет сгенерирован заново

### 3.2 Ошибки на сервере при генерации

**Место**: `app/api/plan/generate/route.ts:28-127`

- ❌ **Отсутствие initData**
  - Причина: Отсутствует заголовок `X-Telegram-Init-Data`
  - Обработка: `ApiResponse.unauthorized('Missing Telegram initData')`
  - Последствия: Клиент получает 401

- ❌ **Недействительный initData**
  - Причина: `getUserIdFromInitData()` вернул `null`
  - Обработка: `ApiResponse.unauthorized('Invalid or expired Telegram initData')`
  - Последствия: Клиент получает 401

- ❌ **Профиль не найден**
  - Причина: У пользователя нет `SkinProfile` в БД
  - Обработка: `ApiResponse.notFound('No skin profile found')`
  - Последствия: Клиент получает 404

- ❌ **Таймаут генерации (60 секунд)**
  - Причина: Генерация плана занимает больше 60 секунд
  - Обработка: `Promise.race()` с таймаутом, возвращается `500 Internal Server Error`
  - Последствия: Клиент получает ошибку

- ❌ **Ошибка в generate28DayPlan()**
  - Причина: Ошибка при генерации плана (логика, БД, внешние API)
  - Обработка: Catch блок, логирование, возвращается `500 Internal Server Error`
  - Последствия: Клиент получает ошибку

- ❌ **Пустой результат генерации**
  - Причина: `generate28DayPlan()` вернул пустой план
  - Обработка: `ApiResponse.error('Plan generation returned empty result', 500)`
  - Последствия: Клиент получает ошибку

- ❌ **План без дней**
  - Причина: `plan28.days` пустой массив
  - Обработка: `ApiResponse.error('Plan generation returned empty days', 500)`
  - Последствия: Клиент получает ошибку

### 3.3 Ошибки при сохранении плана в БД

**Место**: `app/api/plan/generate/route.ts:189-250`

- ❌ **План без дней перед сохранением**
  - Причина: `plan28.days` пустой или не массив
  - Обработка: Выбрасывается ошибка `'Plan28.days is empty or invalid'`
  - Последствия: Ошибка попадает в catch, возвращается 500

- ❌ **Ошибка сохранения в Prisma**
  - Причина: Ошибка БД при сохранении плана
  - Обработка: Catch блок, логирование, возвращается 500
  - Последствия: План не сохраняется в БД, клиент получает ошибку

- ❌ **Ошибка кэширования**
  - Причина: Ошибка при сохранении в Redis кэш
  - Обработка: Логирование, но сохранение в БД продолжается
  - Последствия: План сохраняется в БД, но не кэшируется

---

## 4. Ошибки при ожидании готовности плана

**Место**: `app/(miniapp)/quiz/page.tsx:2796-2850`

- ❌ **Таймаут ожидания (60 секунд)**
  - Причина: План не готов в течение 60 секунд
  - Обработка: Цикл прерывается, редирект все равно происходит
  - Последствия: Пользователь редиректится, план может быть еще не готов

- ❌ **Ошибка при проверке плана (`api.getPlan()`)**
  - Причина: Сетевая ошибка, 404, 500
  - Обработка: Проверка `planError?.status !== 404`, логирование, цикл продолжается
  - Последствия: Ожидание продолжается, если это не 404

- ❌ **План без продуктов**
  - Причина: План найден, но без продуктов в первом дне
  - Обработка: Логирование, цикл продолжается
  - Последствия: Ожидание продолжается, возможен таймаут

- ❌ **Размонтирование компонента**
  - Причина: Компонент размонтирован во время ожидания
  - Обработка: Проверка `isMountedRef.current`, прерывание цикла
  - Последствия: Ожидание прекращается, редирект не происходит

---

## 5. Ошибки при редиректе на /plan

**Место**: `app/(miniapp)/quiz/page.tsx:2850-2880`

- ❌ **Ошибка установки флага `quiz_just_submitted`**
  - Причина: Ошибка при работе с `sessionStorage`
  - Обработка: Только логирование, не критично
  - Последствия: При следующей загрузке `/plan` может показаться анкета (если флаг не установлен)

- ❌ **Ошибка редиректа (`window.location.replace('/plan')`)**
  - Причина: Браузер блокирует редирект или ошибка навигации
  - Обработка: Не обрабатывается явно
  - Последствия: Пользователь остается на странице анкеты с лоадером

---

## 6. Ошибки при загрузке плана на странице /plan

**Место**: `app/(miniapp)/plan/page.tsx:77-500`

### 6.1 Ошибки инициализации

- ❌ **Telegram WebApp не доступен**
  - Причина: Приложение открыто не через Telegram
  - Обработка: Редирект на `/quiz`
  - Последствия: Пользователь перенаправляется на анкету

### 6.2 Ошибки при загрузке плана

- ❌ **Профиль не найден (`api.getCurrentProfile()`)**
  - Причина: У пользователя нет профиля
  - Обработка: Редирект на `/quiz`
  - Последствия: Пользователь перенаправляется на анкету

- ❌ **План не найден (`api.getPlan()`)**
  - Причина: План еще не сгенерирован или удален
  - Обработка: Автоматическая генерация плана (`api.generatePlan()`)
  - Последствия: План генерируется заново

### 6.3 Ошибки при генерации плана на странице

- ❌ **Rate limit (429)**
  - Причина: Слишком много запросов на генерацию
  - Обработка: Установка cooldown, показ ошибки с временем ожидания
  - Последствия: Пользователь видит ошибку, нужно подождать

- ❌ **Таймаут генерации**
  - Причина: Генерация занимает больше времени, чем ожидается
  - Обработка: Показ ошибки, возможность повторить
  - Последствия: Пользователь видит ошибку

- ❌ **Пустой результат генерации**
  - Причина: План сгенерирован, но пустой
  - Обработка: Показ ошибки, возможность повторить
  - Последствия: Пользователь видит ошибку

- ❌ **Сетевая ошибка**
  - Причина: Потеря соединения
  - Обработка: Показ ошибки, возможность повторить
  - Последствия: Пользователь видит ошибку

### 6.4 Ошибки при отображении плана

- ❌ **Отсутствие данных плана**
  - Причина: План загружен, но структура некорректна
  - Обработка: Проверка наличия `plan28` или `weeks`, показ ошибки если нет
  - Последствия: Пользователь видит ошибку вместо плана

- ❌ **Отсутствие продуктов**
  - Причина: План есть, но продукты не загружены
  - Обработка: Загрузка продуктов через `api.getProducts()`
  - Последствия: Если загрузка не удалась, продукты не отображаются

---

## Критические проблемы и рекомендации

### Проблема 1: Редирект происходит даже при ошибке генерации

**Место**: `app/(miniapp)/quiz/page.tsx:2787-2794`

```typescript
// ИСПРАВЛЕНО: Если генерация не удалась, все равно редиректим - план перегенерируется на странице /plan
clientLogger.warn('⚠️ Ошибка при генерации плана (продолжаем редирект):', ...);
```

**Проблема**: При ошибке генерации пользователь все равно редиректится на `/plan`, что может привести к:
- Двойной генерации плана
- Ошибке на странице плана
- Плохому UX (пользователь видит ошибку после лоадера)

**Рекомендация**: 
- Обрабатывать критические ошибки генерации (не таймауты) и не редиректить
- Показывать ошибку пользователю с возможностью повторить
- Редиректить только при таймауте или некритических ошибках

### Проблема 2: Двойная генерация плана

**Место**: 
- `app/(miniapp)/quiz/page.tsx:2600` - генерация после отправки ответов
- `app/(miniapp)/plan/page.tsx:144` - автоматическая генерация если план не найден

**Проблема**: Если генерация в `submitAnswers` не успела завершиться, на странице `/plan` план будет сгенерирован заново, что:
- Нагружает сервер
- Может привести к рассинхронизации
- Увеличивает время ожидания пользователя

**Рекомендация**:
- Использовать флаг в БД/Redis для отслеживания активной генерации
- На странице `/plan` проверять, не идет ли уже генерация
- Показывать лоадер вместо автоматической регенерации

### Проблема 3: Отсутствие обработки таймаутов на странице плана

**Место**: `app/(miniapp)/plan/page.tsx:128-200`

**Проблема**: При генерации плана на странице нет явного таймаута, что может привести к бесконечному ожиданию.

**Рекомендация**:
- Добавить таймаут (например, 60 секунд)
- Показывать ошибку при таймауте
- Давать возможность повторить попытку

### Проблема 4: Нет явной обработки дубликатов на клиенте

**Место**: `app/(miniapp)/quiz/page.tsx:2278-2320`

**Проблема**: Проверка дубликата есть, но не всегда обрабатывается правильно, что может привести к:
- Повторной отправке ответов
- Созданию дубликатов в БД
- Ошибкам на сервере

**Рекомендация**:
- Более строгая проверка дубликатов на клиенте
- Блокировка повторной отправки (disable кнопки, флаг)
- Более явная обработка ответа с `isDuplicate: true`

### Проблема 5: План может быть пустым без продуктов

**Место**: `app/api/plan/generate/route.ts:243-249`

**Проблема**: План сохраняется даже если в нем нет продуктов, что приводит к:
- Пустому отображению на клиенте
- Некорректному UX
- Ошибкам при отображении

**Рекомендация**:
- Более строгая валидация перед сохранением
- Не сохранять план, если в нем нет продуктов
- Возвращать ошибку вместо сохранения пустого плана

---

## Исправленные проблемы (14.12.2025)

### ✅ Исправление 1: Автоматическое создание PlanProgress

**Проблема**: PlanProgress не создавался при генерации плана, что могло вызывать проблемы с отображением текущего дня.

**Исправление**: 
- Добавлено автоматическое создание PlanProgress в `app/api/plan/generate/route.ts` после сохранения Plan28
- Создан скрипт `scripts/fix-missing-plan-progress.ts` для исправления существующих пользователей

**Статус**: ✅ Исправлено

### ✅ Исправление 2: Улучшена обработка ошибки 404 при загрузке рекомендаций

**Проблема**: Ошибка 404 при загрузке рекомендаций на главной странице логировалась как критическая ошибка, хотя это нормальная ситуация (профиль еще не создан).

**Исправление**:
- Изменен `clientLogger.error` на `clientLogger.log` для ошибки 404
- Улучшены комментарии, объясняющие, что 404 - это нормально
- Ошибка больше не логируется как критическая

**Статус**: ✅ Исправлено

### ✅ Исправление 3: Синтаксические ошибки в quiz/page.tsx

**Проблемы**: 
1. Лишние закрывающие теги `</>` и `)}` на строках 6326-6327
2. Маркеры конфликта слияния git (`>>>>>>> origin/cursor/care-plan-prompt-issue-505b`)
3. Неправильная структура JSX (отсутствовал закрывающий Fragment `</>`)
4. Дублирующееся объявление переменной `answersCount`

**Исправления**: 
- Удалены лишние закрывающие теги
- Удалены маркеры конфликта слияния
- Исправлена структура JSX (добавлен закрывающий Fragment)
- Удалено дублирующееся объявление `answersCount`

**Статус**: ✅ Исправлено

---

## Чеклист проверки ошибок

### Перед отправкой ответов:
- [ ] Анкета загружена (`questionnaire !== null`)
- [ ] Есть ответы (`Object.keys(answers).length > 0`)
- [ ] `initData` доступен (`window.Telegram?.WebApp?.initData`)
- [ ] Ответы валидны (все имеют `questionId`)

### После отправки ответов:
- [ ] Профиль создан (`result?.profile?.id`)
- [ ] Кэш профиля очищен
- [ ] Флаг `quiz_just_submitted` установлен

### При генерации плана:
- [ ] Таймаут установлен (30 секунд на клиенте, 60 на сервере)
- [ ] План не пустой (`hasPlan28 || hasWeeks`)
- [ ] План содержит продукты
- [ ] План сохранен в БД
- [x] PlanProgress создан автоматически (исправлено 14.12.2025)

### При редиректе:
- [ ] Флаг `quiz_just_submitted` установлен
- [ ] План готов (или есть fallback)
- [ ] Компонент еще смонтирован

### На странице плана:
- [ ] Профиль существует
- [ ] План существует или генерируется
- [x] PlanProgress существует (создается автоматически при генерации)
- [ ] Продукты загружены
- [x] Ошибка 404 при загрузке рекомендаций обработана корректно (исправлено 14.12.2025)
