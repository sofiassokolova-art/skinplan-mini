# Отчет о потенциальных проблемах между анкетой и планом

## Обнаруженные проблемы

### 1. ❌ План пустой (`plan28.plan28` пустой или null)
**Проблема:** План создан в БД, но структура данных пустая.

**Возможные причины:**
- Ошибка при сохранении плана в БД
- План не был правильно сгенерирован
- Структура данных не соответствует ожидаемой

**Где проверить:**
- `lib/plan-generator.ts` - функция `generate28DayPlan`
- `app/api/plan/generate/route.ts` - сохранение плана
- Структура `Plan28.plan28` в БД

### 2. ❌ Несоответствие правила профилю
**Проблема:** Правило "Акне 3–4 степени" требует `inflammation >= 85`, но в профиле `inflammation = 0`.

**Возможные причины:**
- Правило было выбрано неправильно при создании `RecommendationSession`
- `inflammation` не вычисляется правильно из ответов
- Нормализация значений не применяется при проверке правил

**Где проверить:**
- `app/api/questionnaire/answers/route.ts` - создание `RecommendationSession`
- `app/api/recommendations/route.ts` - проверка правил
- `lib/skin-analysis-engine.ts` - вычисление `inflammation`

### 3. ⚠️ Большая задержка между сессией и планом
**Проблема:** `RecommendationSession` создан в 12:22:45, а `Plan28` создан в 12:58:07 (35 минут задержки).

**Возможные причины:**
- План генерируется не сразу после создания сессии
- Пользователь не сразу перешел к генерации плана
- Ошибка при генерации плана, которая была исправлена позже

**Где проверить:**
- `app/(miniapp)/quiz/page.tsx` - логика генерации плана после отправки ответов
- `app/api/plan/generate/route.ts` - таймауты и ошибки

### 4. ⚠️ Нормализация типа кожи
**Проблема:** Тип кожи `"combo"` нормализуется в `"combination_oily"` для правил.

**Статус:** ✅ Это исправлено в последнем коммите, но нужно убедиться, что нормализация применяется везде.

**Где проверить:**
- `lib/skin-type-normalizer.ts` - функция нормализации
- Все места, где используется `profile.skinType` для проверки правил

## Потенциальные проблемы в flow

### A. Порядок операций
1. ✅ Ответы сохраняются в БД
2. ✅ Создается/обновляется `SkinProfile`
3. ✅ Создается `RecommendationSession`
4. ❓ Генерируется план (может быть задержка)
5. ❓ План сохраняется в БД

**Проблема:** Если план генерируется на клиенте, может быть race condition или задержка.

### B. Вычисление scores
**Проблема:** `inflammation` и другие scores вычисляются из `QuestionnaireAnswers`, но:
- В `questionnaire/answers/route.ts` формируется `questionnaireAnswers` из `fullAnswers`
- В `plan-generator.ts` формируется `questionnaireAnswers` из `userAnswers` из БД
- Могут быть различия в данных

**Где проверить:**
- `app/api/questionnaire/answers/route.ts:790-812` - формирование `questionnaireAnswers`
- `lib/plan-generator.ts:254-269` - формирование `questionnaireAnswers`

### C. Нормализация значений
**Проблема:** Нормализация применяется в:
- ✅ `app/api/questionnaire/answers/route.ts` - при создании `RecommendationSession`
- ✅ `app/api/recommendations/route.ts` - при получении рекомендаций
- ❓ `lib/plan-generator.ts` - при генерации плана (нужно проверить)

**Где проверить:**
- `lib/plan-generator.ts:293-301` - нормализация для `stepProfile`
- `lib/plan-generator.ts:399-406` - нормализация для `carePlanProfileInput`

### D. Структура плана
**Проблема:** План может быть сохранен в разных форматах:
- `plan28.plan28.days` - массив дней
- `plan28.plan28.weeks` - массив недель
- `plan28.plan28` - может быть null или пустым

**Где проверить:**
- `lib/plan-generator.ts` - структура возвращаемого плана
- `app/api/plan/generate/route.ts` - сохранение плана в БД
- `app/api/plan/route.ts` - чтение плана из БД

## Рекомендации по исправлению

1. **Проверить сохранение плана:**
   - Убедиться, что план правильно сохраняется в `plan28.plan28`
   - Добавить валидацию структуры плана перед сохранением

2. **Исправить проверку правил:**
   - Убедиться, что `inflammation` вычисляется правильно
   - Проверить, что нормализация применяется при проверке правил

3. **Унифицировать вычисление scores:**
   - Использовать одну функцию для формирования `QuestionnaireAnswers`
   - Убедиться, что данные из БД совпадают с данными при создании сессии

4. **Добавить логирование:**
   - Логировать все этапы генерации плана
   - Логировать вычисленные scores и нормализованные значения
   - Логировать структуру сохраненного плана
