# Настройка платежей (ЮKassa)

В production для приёма оплаты нужны переменные окружения ЮKassa.

## Переменные окружения

| Переменная | Описание |
|------------|----------|
| `YOOKASSA_SHOP_ID` | Идентификатор магазина из личного кабинета ЮKassa |
| `YOOKASSA_SECRET_KEY` | Секретный ключ (live или test). **Не коммитить в репозиторий.** Задать в Vercel / сервере: Settings → Environment Variables |
| `YOOKASSA_RECEIPT_EMAIL` | Опционально. Email для чека 54-ФЗ, если у пользователя нет телефона в профиле (по умолчанию используется noreply@proskiniq.ru) |
| `YOOKASSA_TAX_SYSTEM_CODE` | Опционально. Код системы налогообложения для чека (1 = OSN, 2 = USN income, 3 = USN income-outcome, 4 = ESN, 5 = patent). По умолчанию: 1 |
| `PAYMENTS_WEBHOOK_SECRET` | Опционально. Если задан — вебхук принимается только с заголовком `X-Webhook-Secret` с тем же значением. **Для ЮKassa не нужен**: в настройках уведомлений нельзя добавить свой заголовок, поэтому уведомления принимаются по формату тела (event + object.id) |

## Где взять ключи

1. [Личный кабинет ЮKassa](https://yookassa.ru/) → Настройки → Ключи API.
2. **Shop ID** — идентификатор магазина (число или строка).
3. **Секретный ключ** — для боевой среды ключ с префиксом `live_`, для тестов — `test_`.

## Автоматическое подтверждение платежей

При создании платежа в коде передаётся **`capture: true`**. Это значит одностадийный сценарий: после успешной оплаты пользователем платёж сразу переходит в статус `succeeded`, без ручного подтверждения (capture) с вашей стороны. Деньги списываются автоматически. Если нужен двухстадийный сценарий (сначала `waiting_for_capture`, затем явный capture) — измените параметр в `app/api/payments/create/route.ts`.

## Вебхуки

В ЮKassa укажите URL уведомлений: `https://ваш-домен.com/api/payments/webhook`  
Заголовок `X-Webhook-Secret` задавать **не нужно** — в интерфейсе ЮKassa нельзя добавить кастомные заголовки. Уведомления принимаются по формату тела (`event`, `object.id`, `object.status`).

## Mobile SDK

Для Telegram Mini App **отдельный mobile SDK не нужен**: оплата идёт через браузер (редирект на страницу ЮKassa). Достаточно серверного API и фронта, который открывает `paymentUrl` из ответа `/api/payments/create`.
