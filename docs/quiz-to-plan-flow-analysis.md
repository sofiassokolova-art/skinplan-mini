# Анализ логики перехода от вопросов к плану

## Поток: Вопросы → Лоадер → План → Шлюз оплаты

### 1. Вопросы (quiz/page.tsx)

**Точка отправки ответов:**
- Пользователь завершает анкету
- Вызывается `submitAnswers()`
- Устанавливается `isSubmitting = true`
- Устанавливается флаг `quiz_just_submitted = true` в sessionStorage

**Логика показа лоадера:**
- Лоадер "Создаем ваш план ухода..." показывается если:
  - `isSubmitting === true` И
  - `loading === false` И
  - `questionnaire !== null` И
  - ИЛИ `looksLikeCompletion` (анкета завершена, есть ответы)

**Редирект на /plan:**
- Происходит через `window.location.replace('/plan')`
- После установки флага `quiz_just_submitted`
- После проверки готовности плана (или разрешения редиректа)

### 2. Страница плана (plan/page.tsx)

**При загрузке:**
- Проверяется флаг `quiz_just_submitted` - если установлен, происходит редирект
- Вызывается `loadPlan()`
- Пытается загрузить план из кэша/БД
- Если план не найден - пытается сгенерировать

**Логика загрузки:**
- Сначала проверяется кэш
- Затем проверяется БД
- Если не найдено - проверяется профиль
- Если профиль есть - генерируется план
- Если профиля нет - показывается ошибка 'no_profile'

**Проблемы:**
1. ❌ PaymentGate всегда показывает блюр, если `hasPaid = false`
2. ❌ Нет связи между первой генерацией плана и показом PaymentGate
3. ❌ Лоадер на странице quiz может конфликтовать с лоадером на странице plan

### 3. PaymentGate (components/PaymentGate.tsx)

**Текущая логика:**
- Проверяет `localStorage.getItem('payment_first_completed') === 'true'`
- Если `hasPaid = false` - показывает блюр с экраном оплаты
- Если `hasPaid = true` - показывает контент без блюра

**Проблемы:**
1. ❌ PaymentGate показывает блюр ВСЕГДА, если не оплачено
2. ❌ Это означает, что даже после первой генерации плана показывается блюр
3. ❌ Нет логики "первый план бесплатно, второй платно"

### 4. Генерация плана

**Триггеры:**
- После отправки ответов на quiz (автоматически)
- При загрузке страницы plan, если план не найден
- При ручном обновлении на странице plan

**Проблемы:**
1. ⚠️ Генерация может занимать время, но лоадер может не показываться правильно
2. ⚠️ Нет четкой связи между генерацией и PaymentGate

## Проблемы логики

### Проблема 1: PaymentGate показывает блюр всегда

**Текущее поведение:**
- PaymentGate в `plan-client-new.tsx` всегда оборачивает контент
- Если `hasPaid = false`, показывается блюр
- Это означает, что даже первый план требует оплаты

**Ожидаемое поведение:**
- Первый план должен быть бесплатным
- PaymentGate должен показываться только при перепрохождении или продлении

**Решение:**
- Проверять, существует ли уже план в БД
- Если план есть и это первый - не показывать PaymentGate
- Если план истек (28+ дней) - показывать PaymentGate
- Если это перепрохождение - показывать PaymentGate

### Проблема 2: Конфликт лоадеров

**Текущее поведение:**
- Лоадер на quiz показывается при `isSubmitting`
- После редиректа на plan показывается другой лоадер
- Может быть двойной показ лоадеров

**Решение:**
- Лоадер на quiz должен быть виден минимальное время (1.5 секунды)
- На plan лоадер должен показываться только если план не найден и генерируется

### Проблема 3: Гонка условий при генерации плана

**Текущее поведение:**
- После редиректа на plan может быть race condition
- План может быть еще в процессе генерации
- Показывается лоадер, но PaymentGate может быть показан до готовности плана

**Решение:**
- PaymentGate должен проверять состояние плана
- Если план генерируется - не показывать PaymentGate
- Если план готов - проверять нужно ли показывать PaymentGate

### Проблема 4: Нет четкой связи между первой генерацией и оплатой

**Текущее поведение:**
- После первой генерации плана PaymentGate все равно показывается
- Нет логики "первый план бесплатно"

**Решение:**
- При первой генерации плана устанавливать флаг "первый план создан"
- PaymentGate должен проверять этот флаг
- Если первый план уже был - показывать PaymentGate
- Если первый план еще не был - не показывать PaymentGate

## Исправления

### ✅ 1. Изменена логика PaymentGate

**Файл**: `app/(miniapp)/plan/plan-client-new.tsx`

- PaymentGate показывается только если:
  - План истек (28+ дней) - `planExpired === true`
  - Это перепрохождение анкеты - флаги `is_retaking_quiz` или `full_retake_from_home` в localStorage
- При первой генерации плана PaymentGate НЕ показывается
- Используется prop `planExpired`, переданный из родительского компонента
- Не делаются дополнительные API запросы для проверки статуса

### ✅ 2. Улучшена логика показа лоадера

**На quiz (`app/(miniapp)/quiz/page.tsx`):**
- Лоадер показывается при `isSubmitting === true` ИЛИ `looksLikeCompletion`
- Минимальная задержка 1.5 секунды перед редиректом для видимости лоадера
- Используется `window.location.replace('/plan')` для редиректа

**На plan (`app/(miniapp)/plan/page.tsx`):**
- Лоадер показывается при `loading === true`
- Если план найден в БД/кэше - лоадер скрывается
- Если план генерируется - лоадер показывается

### ✅ 3. Добавлена проверка "первый план vs перепрохождение"

- Проверяется флаг `planExpired` из ответа API
- Проверяются флаги перепрохождения в localStorage
- PaymentGate показывается только если план истек ИЛИ это перепрохождение
- При первой генерации PaymentGate не показывается

### ✅ 4. Улучшена передача данных между компонентами

- Флаг `planExpired` сохраняется в `planData`
- Передается в `PlanPageClientNew` как prop
- Используется для определения необходимости показа PaymentGate
