# Проверка флоу: Анкета → Лоадер → Генерация плана → Страница плана

## Текущий флоу (проверено в коде)

### 1. Пользователь проходит анкету ✅
- **Файл:** `app/(miniapp)/quiz/page.tsx`
- **Логика:** Когда все вопросы отвечены (`currentQuestionIndex >= allQuestions.length`), автоматически запускается `submitAnswers()` через 5 секунд
- **Строки:** 2297-2338

### 2. Показывается лоадер ✅
- **Файл:** `app/(miniapp)/quiz/page.tsx`
- **Логика:** 
  - При запуске `submitAnswers()` устанавливается `setIsSubmitting(true)` (строка 1161)
  - Устанавливается `setLoading(false)` чтобы скрыть лоадер "Загрузка анкеты..." (строка 1163)
  - Показывается лоадер "Создаем ваш план ухода..." (строки 3569-3658, 3776-3780)
- **Условие показа:** `if (isSubmitting)` (строка 3560)

### 3. Сохранение ответов и создание профиля ✅
- **Файл:** `app/api/questionnaire/answers/route.ts`
- **Логика:**
  - Ответы сохраняются в БД через `prisma.userAnswer.upsert` (строки 115-162)
  - Создается/обновляется `SkinProfile` (строки 179-341)
  - Создается `RecommendationSession` с продуктами (строки 392-925)
  - **ВАЖНО:** Ответы НЕ удаляются после сохранения (строка 946-950)
- **Вызов:** `api.submitAnswers()` в `quiz/page.tsx` (строка 1259)

### 4. Генерация плана ✅
- **Файл:** `app/(miniapp)/quiz/page.tsx` → `app/api/plan/generate/route.ts`
- **Логика:**
  - После успешного сохранения ответов вызывается `api.generatePlan()` (строка 1311)
  - `generate28DayPlan()` получает ответы из БД для активной анкеты (строки 245-268 в `route.ts`)
  - План генерируется на основе ответов и профиля (строки 270-298 в `route.ts`)
  - План сохраняется в кэш (через `setCachedPlan`)
- **Проверка готовности:** После генерации проверяется готовность плана в кэше (строки 1376-1400)

### 5. Очистка ответов ✅
- **Файл:** `app/(miniapp)/quiz/page.tsx`
- **Логика:**
  - Ответы удаляются из БД ТОЛЬКО после успешной генерации плана (строки 1402-1415)
  - Если план не готов, ответы остаются в БД для повторной генерации на странице `/plan`
- **Вызов:** `api.clearQuizProgress()` (строка 1407)

### 6. Редирект на страницу плана ✅
- **Файл:** `app/(miniapp)/quiz/page.tsx`
- **Логика:**
  - Редирект происходит после проверки готовности плана (строки 1421-1430)
  - Используется `window.location.replace('/plan')` для полной перезагрузки страницы
  - `isMountedRef.current = false` устанавливается перед редиректом для предотвращения React Error #300

### 7. Загрузка плана на странице `/plan` ✅
- **Файл:** `app/(miniapp)/plan/page.tsx`
- **Логика:**
  - При монтировании компонента вызывается `loadPlan()` (строка 97)
  - `loadPlan()` пытается загрузить план из кэша через `api.getPlan()`
  - Если план не найден, вызывается `tryGeneratePlan()` для генерации (строки 111-150)
  - План отображается через `PlanPageClientNew` компонент

## Проверка ключевых моментов

### ✅ Ответы записываются
- **Где:** `app/api/questionnaire/answers/route.ts`, строки 115-162
- **Как:** Используется `prisma.userAnswer.upsert` для сохранения/обновления ответов
- **Проверка:** Ответы сохраняются в транзакции вместе с профилем

### ✅ План генерируется на основе ответов
- **Где:** `app/api/plan/generate/route.ts`, строки 245-298
- **Как:** 
  - Получаются ответы для активной анкеты: `prisma.userAnswer.findMany({ where: { userId, questionnaireId: activeQuestionnaire.id } })`
  - Ответы парсятся в формат `Record<string, any>` (строки 272-280)
  - Используются в `questionnaireAnswers` для расчета осей кожи и рекомендаций (строки 283-298)

### ✅ Лоадер показывается во время генерации
- **Где:** `app/(miniapp)/quiz/page.tsx`, строки 3560-3783
- **Как:** 
  - `isSubmitting` устанавливается в `true` при запуске `submitAnswers()` (строка 1161)
  - Лоадер "Создаем ваш план ухода..." показывается пока `isSubmitting === true`
  - Лоадер скрывается только после редиректа (компонент размонтируется)

### ✅ Ответы не удаляются до генерации плана
- **Где:** `app/(miniapp)/quiz/page.tsx`, строки 1286-1415
- **Как:**
  - После `api.submitAnswers()` очищается только `localStorage` (строка 1292)
  - Ответы в БД НЕ удаляются сразу (строки 1286-1288)
  - Ответы удаляются только после успешной генерации плана (строки 1402-1415)

### ✅ Редирект происходит только после готовности плана
- **Где:** `app/(miniapp)/quiz/page.tsx`, строки 1376-1430
- **Как:**
  - После `api.generatePlan()` проверяется готовность плана в кэше (строки 1376-1400)
  - Редирект происходит только если план готов (`planReady === true`)
  - Если план не готов, ответы остаются в БД для генерации на странице `/plan`

## Потенциальные проблемы

### ⚠️ Таймаут ожидания плана
- **Где:** `app/(miniapp)/quiz/page.tsx`, строка 1371
- **Проблема:** Максимальное время ожидания - 60 секунд (`MAX_WAIT_TIME = 60000`)
- **Решение:** Если план не готов за 60 секунд, редирект все равно происходит, план генерируется на странице `/plan`

### ⚠️ Проверка готовности плана
- **Где:** `app/(miniapp)/quiz/page.tsx`, строки 1376-1400
- **Проблема:** Проверка происходит каждые 500ms через `api.getPlan()`, что может быть неэффективно
- **Решение:** Текущая реализация достаточна, но можно оптимизировать через WebSocket или Server-Sent Events

## Выводы

✅ **Все ключевые моменты работают правильно:**
1. Ответы записываются в БД при отправке анкеты
2. План генерируется на основе сохраненных ответов
3. Лоадер показывается во время генерации
4. Ответы не удаляются до успешной генерации плана
5. Редирект происходит только после готовности плана
6. На странице `/plan` план загружается из кэша или генерируется заново

**Рекомендации:**
- Добавить более детальное логирование для отслеживания времени генерации плана
- Рассмотреть возможность использования WebSocket для уведомления о готовности плана
- Добавить метрики для мониторинга успешности генерации плана

