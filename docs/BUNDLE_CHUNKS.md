# Размеры чанков (client)

## Домен для мини-приложения в Telegram

Чанки грузятся с того же домена, с которого открыта страница (относительные пути `/_next/static/...`). Чтобы в Telegram не показывало «Не удалось загрузить приложение», в боте ссылка на мини-приложение должна вести на **основной домен**: `https://www.proskiniq.ru` (или ваш кастомный домен). Тогда и HTML, и все чанки запрашиваются с одного origin, без лишних 404 и таймаутов. В BotFather / настройках бота проверьте, что Web App URL указан как `https://www.proskiniq.ru`.

## Как посмотреть полный отчёт

```bash
ANALYZE=true npm run build
```

После сборки открой в браузере:

- **Клиент (браузер):** `.next/analyze/client.html`
- Сервер Node: `.next/analyze/nodejs.html`
- Edge: `.next/analyze/edge.html`

Или одной командой (macOS):

```bash
open .next/analyze/client.html
```

---

## Крупнейшие чанки (по последнему анализу)

| Размер | Чанк | Примечание |
|--------|------|------------|
| **~637 KB** | `animations.*.js` | framer-motion, lottie — грузится по требованию (страницы с анимациями) |
| **~551 KB** | `vendor-*.js` | React, общие библиотеки — в первом запросе |
| **~378 KB** | `9993-*.js` | Общий код (root main) — в первом запросе |
| **~316 KB** | `6820-*.js` | Доп. общий код |
| **~174 KB** | `app/(miniapp)/quiz/page-*.js` | Страница анкеты |
| **~138 KB** | `app/(miniapp)/plan/page-*.js` | Страница плана |
| **~114 KB** | `2867-*.js` | Общий чанк |
| **~110 KB** | `polyfills-*.js` | Полифиллы |
| **~81 KB** | `4167-*.js` | Общий чанк |
| **~50 KB** | `app/(miniapp)/layout-*.js` | Layout мини-аппа |
| **~16 KB** | `app/layout-*.js` | Корневой layout |

Хеши в именах файлов (`*`) меняются при каждой сборке.

---

## Что грузится при первом открытии мини-аппа

Обычно в первый запрос попадают:

- `webpack-*.js`, `main-app-*.js`, `9993-*.js` (из `build-manifest.json` rootMainFiles)
- `polyfills-*.js`
- `vendor-*.js` (или его части)
- `app/layout-*.js`, `app/(miniapp)/layout-*.js`
- Страница (например `app/(miniapp)/page-*.js` или quiz/page)

Чанк `animations` подгружается только на страницах с анимациями (ленивая загрузка).

---

## Что уже сделано для уменьшения чанков

1. **PageTransition** — переведён на CSS-анимацию (без framer-motion). Чанк `animations` (~637 KB) больше не грузится при первом открытии, только при заходе на страницы с Lottie (например план).
2. **splitChunks:** React вынесен в отдельный чанк `framework` (лучше кэш); chart.js, pdf, animations, prisma — только async; остальное в `vendor`.
3. **Админка** — свои чанки, грузятся только при заходе в `/admin/*`.

## Если чанки таймаутят на проде

1. **Регион Vercel:** выставить ближе к пользователям (Settings → General → Region).
2. **Проверить сеть:** в DevTools → Network смотреть, какой именно файл даёт ERR_TIMED_OUT и его размер.
3. **Доп. разбиение:** тяжёлые страницы (quiz, plan) можно дальше дробить через `next/dynamic` для редко используемых подкомпонентов.

---

## Тайминг запроса к / (Время → Вкладка «Время»)

- **Остановлено (Stalled) ~60–70 мс** — очередь/подключение до отправки запроса. Может расти из‑за лимита соединений к домену, прокси, DNS.
- **Ожидание ответа сервера (TTFB) ~170 мс** — время до первого байта HTML. Основная задержка «белый фон → зелёный экран»: пока сервер не отдал ответ, браузер не может рисовать страницу. Снижается: регион Vercel ближе к пользователям, меньше работы на сервере для `/`.
- **Скачивание контента ~5 мс** — сам HTML маленький, задержка не в нём.

Чтобы не было белой вспышки до зелёного экрана, у `body` в production задан тот же зелёный градиент фоном — первый кадр сразу зелёный.

---

## Ошибки загрузки: layout-*.js, main-app-*.js, vendor-*.js, webpack-*.js, CSS, шрифты

Если в Network падают с красным крестом запросы к `/_next/static/...` (layout, main-app, vendor, webpack, чанки 2867, 4986, 9993, один CSS, шрифты .p.ttf), страница остаётся на белом/зелёном экране.

**Частая причина:** устаревший HTML после деплоя. Браузер или прокси отдаёт старую страницу с **старыми** URL чанков (старые хеши в именах файлов). После нового деплоя на сервере лежат только **новые** файлы, старые удалены → запросы к старым URL дают **404**, приложение не грузится.

**Что сделано в коде:**
- Для всех маршрутов (`/:path*`) добавлен **Cache-Control: no-store, no-cache, must-revalidate**, чтобы HTML не кэшировался и после деплоя пользователь получал свежую разметку с актуальными URL чанков.
- При первой ошибке загрузки скрипта/стиля из `/_next/` выполняется **одна автоматическая перезагрузка** страницы (по флагу в sessionStorage), чтобы подтянуть новый HTML; при повторной ошибке показывается кнопка «Обновить».

**Что проверить вручную:** вкладка Network → клик по упавшему запросу → смотреть **Status** (404 = старый URL, 403 = блокировка, сеть/таймаут = другая причина). При 404 помогает жёсткое обновление (Ctrl+Shift+R / Cmd+Shift+R) или очистка кэша.
