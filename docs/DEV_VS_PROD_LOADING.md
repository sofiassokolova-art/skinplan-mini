# Почему на деве всё грузится, а на проде — нет

## Главные отличия dev и prod

### 1. **Telegram initData (самая частая причина)**

| | Development | Production |
|---|-------------|------------|
| Открытие в **браузере** (не из Telegram) | Подставляется **тестовый** initData (мок в layout + в `lib/api/client.ts`). Запросы к API проходят. | initData **нет** → запросы без заголовка `X-Telegram-Init-Data` → API возвращает **401** → контент не грузится. |
| Открытие **из Telegram** (Mini App) | Работает с реальным initData. | Должно работать так же, если переменные окружения заданы. |

**Итог:** в проде приложение рассчитано на запуск **из Telegram**. В браузере по прямой ссылке без мока initData запросы к API будут падать с 401, поэтому «на деве грузит, на проде нет».

**Что проверить в проде:** открывать мини-приложение именно из Telegram (бот, меню, кнопка «Открыть»). Для проверки в браузере без Telegram ожидаемо 401 и отсутствие контента.

---

### 2. **Переменные окружения**

В **Vercel → Project → Settings → Environment Variables** для **Production** должны быть:

- `TELEGRAM_BOT_TOKEN` — токен бота
- `NEXT_PUBLIC_MINI_APP_URL` — **полный URL прода**, например `https://www.proskiniq.ru` (без слэша в конце)
- `DATABASE_URL`, `JWT_SECRET` и остальные по необходимости

Если `NEXT_PUBLIC_MINI_APP_URL` не задан или указывает на другой домен, ссылки и запросы могут уходить не туда.

**API:** по умолчанию используется относительный путь `/api` (то же домен, что и сайт). Дополнительный домен в CSP не нужен — запросы к `'self'` уже разрешены. Только если вы **явно** задаёте `NEXT_PUBLIC_API_URL` на другой домен, его нужно добавить в `connect-src` в `next.config.mjs`.

---

### 3. **CSP (Content-Security-Policy)**

В проде в `next.config.mjs` включён CSP. API по умолчанию на том же домене (`/api`), поэтому `connect-src 'self'` достаточно — отдельно добавлять домен API не требуется.

---

### 4. **Загрузка JS (гидрация)**

На главной странице «/» редирект делается в React (`useEffect`): новый пользователь → `/quiz`, пользователь с планом → `/home`. Пока не загрузятся чанки и не выполнится JS, визуально «ничего не происходит».

- В **dev** бандлы отдаются с сервера разработки, загрузка обычно быстрая.
- В **prod** чанки отдаются с CDN; при медленной сети или ошибке загрузки скрипта гидрация не происходит, редирект не срабатывает.

Принудительный редирект на `/quiz` без JS не делается: иначе пользователи с планом могли бы попадать на анкету вместо главной. Через **15 секунд** показывается только кнопка «Обновить», чтобы перезагрузить страницу.

---

### 5. **Service Worker**

В проде регистрируется Service Worker (`public/sw.js`). Если он кэширует неудачный ответ или старую версию страницы, возможны «не грузит» или старый контент.

**Проверка:** DevTools → Application → Service Workers. Можно временно поставить «Update on reload» или «Unregister» и перезагрузить страницу.

---

## Чеклист, если на проде не грузится

1. Открывать приложение **из Telegram** (не по прямой ссылке в браузере).
2. В Vercel для **Production** проверить переменные: `TELEGRAM_BOT_TOKEN`, `NEXT_PUBLIC_MINI_APP_URL`, `DATABASE_URL`, `JWT_SECRET`.
3. В браузере на проде открыть DevTools (F12) → вкладка **Network**: есть ли красные запросы (4xx/5xx), к каким URL идут запросы (тот ли домен).
4. Вкладка **Console**: есть ли ошибки JS (красные), блокировки CSP.
5. По умолчанию API на том же домене (`/api`); отдельный домен в CSP добавлять не нужно.

После правок переменных или конфига нужен новый деплой.
