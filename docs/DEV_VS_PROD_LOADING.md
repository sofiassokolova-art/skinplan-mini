# Почему на деве всё грузится, а на проде — нет

## Почему на домене Vercel (develop) работает, а на кастомном (proskiniq.ru) — нет

Один и тот же код: по ссылке **preview (develop)** в Telegram всё открывается, по ссылке **www.proskiniq.ru** — «не удалось загрузить приложение». Возможные причины:

| Причина | Пояснение |
|--------|-----------|
| **Кэш (HTML / CDN)** | У кастомного домена URL один и тот же. После деплоя пользователь или прокси может отдавать **старый HTML** → в нём ссылки на старые чанки `/_next/static/.../xxx-[old-hash].js` → 404, наш fallback «Не удалось загрузить приложение». У preview-ссылки Vercel часто новый URL на каждый деплой — кэша нет. |
| **Прокси перед доменом** | Если перед www.proskiniq.ru стоит Cloudflare, nginx или другой прокси, он может кэшировать ответы или менять заголовки (Cache-Control, CSP). Нужно отключить кэш для HTML или убедиться, что для `/*` отдаётся `Cache-Control: no-store, no-cache`. |
| **Service Worker** | В проде регистрируется SW (`/sw.js`). На кастомном домене он может отдавать закэшированную страницу или неудачный ответ. На preview-URL SW может не успеть «прижиться» или домен каждый раз новый. **Проверка:** в Telegram открыть сайт → в настройках/дебаге (если доступно) очистить данные сайта или отключить SW для этого origin. |
| **Разные окружения Vercel** | Preview (develop) и Production (main) — разные деплои. У Production должны быть заданы переменные для **прода**: `TELEGRAM_BOT_TOKEN`, `NEXT_PUBLIC_MINI_APP_URL=https://www.proskiniq.ru`, `DATABASE_URL`, `JWT_SECRET`. Если что-то задано только для Preview, на кастомном домене будет не то поведение. |

**Что сделать:**

1. **Проверить кэш:** в Vercel для Production для `/` и `/:path*` уже стоит `Cache-Control: no-store, no-cache`. Если перед доменом есть CDN/прокси — настроить его так, чтобы не кэшировать HTML или уважать эти заголовки.
2. **Проверить, что грузится именно прод:** открыть в Telegram **https://www.proskiniq.ru/miniapp-ping** — должна открыться страница с текстом «OK» (без React). Если «OK» есть, домен и заголовки в порядке, проблема в загрузке чанков или в Service Worker. Если и `/miniapp-ping` не открывается — смотреть блокировки (CSP, frame-ancestors, сеть).
3. **Переменные:** Vercel → Project → Production → Environment Variables — убедиться, что `NEXT_PUBLIC_MINI_APP_URL` = `https://www.proskiniq.ru` (без слэша в конце).
4. **Service Worker:** временно отключить или не кэшировать HTML в `public/sw.js`, передеплоить и проверить открытие с кастомного домена в Telegram.

---

## Главные отличия dev и prod

### 1. **Telegram initData (самая частая причина)**

| | Development | Production |
|---|-------------|------------|
| Открытие в **браузере** (не из Telegram) | Подставляется **тестовый** initData (мок в layout + в `lib/api/client.ts`). Запросы к API проходят. | initData **нет** → запросы без заголовка `X-Telegram-Init-Data` → API возвращает **401** → контент не грузится. |
| Открытие **из Telegram** (Mini App) | Работает с реальным initData. | Должно работать так же, если переменные окружения заданы. |

**Итог:** в проде приложение рассчитано на запуск **из Telegram**. В браузере по прямой ссылке без мока initData запросы к API будут падать с 401, поэтому «на деве грузит, на проде нет».

**Что проверить в проде:** открывать мини-приложение именно из Telegram (бот, меню, кнопка «Открыть»). Для проверки в браузере без Telegram ожидаемо 401 и отсутствие контента.

---

### 2. **Переменные окружения**

В **Vercel → Project → Settings → Environment Variables** для **Production** должны быть:

- `TELEGRAM_BOT_TOKEN` — токен бота
- `NEXT_PUBLIC_MINI_APP_URL` — **полный URL прода**, например `https://www.proskiniq.ru` (без слэша в конце)
- `DATABASE_URL`, `JWT_SECRET` и остальные по необходимости

Если `NEXT_PUBLIC_MINI_APP_URL` не задан или указывает на другой домен, ссылки и запросы могут уходить не туда.

**API:** по умолчанию используется относительный путь `/api` (то же домен, что и сайт). Дополнительный домен в CSP не нужен — запросы к `'self'` уже разрешены. Только если вы **явно** задаёте `NEXT_PUBLIC_API_URL` на другой домен, его нужно добавить в `connect-src` в `next.config.mjs`.

---

### 3. **CSP (Content-Security-Policy)**

В проде в `next.config.mjs` включён CSP. API по умолчанию на том же домене (`/api`), поэтому `connect-src 'self'` достаточно — отдельно добавлять домен API не требуется.

---

### 4. **Загрузка JS (гидрация)**

На главной странице «/» редирект делается в React (`useEffect`): новый пользователь → `/quiz`, пользователь с планом → `/home`. Пока не загрузятся чанки и не выполнится JS, визуально «ничего не происходит».

- В **dev** бандлы отдаются с сервера разработки, загрузка обычно быстрая.
- В **prod** чанки отдаются с CDN; при медленной сети или ошибке загрузки скрипта гидрация не происходит, редирект не срабатывает.

Принудительный редирект на `/quiz` без JS не делается: иначе пользователи с планом могли бы попадать на анкету вместо главной. Через **15 секунд** показывается только кнопка «Обновить», чтобы перезагрузить страницу.

---

### 5. **Service Worker**

В проде регистрируется Service Worker (`public/sw.js`). Если он кэширует неудачный ответ или старую версию страницы, возможны «не грузит» или старый контент.

**Проверка:** DevTools → Application → Service Workers. Можно временно поставить «Update on reload» или «Unregister» и перезагрузить страницу.

---

## Чеклист, если на проде не грузится

1. Открывать приложение **из Telegram** (не по прямой ссылке в браузере).
2. В Vercel для **Production** проверить переменные: `TELEGRAM_BOT_TOKEN`, `NEXT_PUBLIC_MINI_APP_URL`, `DATABASE_URL`, `JWT_SECRET`.
3. В браузере на проде открыть DevTools (F12) → вкладка **Network**: есть ли красные запросы (4xx/5xx), к каким URL идут запросы (тот ли домен).
4. Вкладка **Console**: есть ли ошибки JS (красные), блокировки CSP.
5. По умолчанию API на том же домене (`/api`); отдельный домен в CSP добавлять не нужно.

После правок переменных или конфига нужен новый деплой.
