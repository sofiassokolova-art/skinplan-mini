# Почему «лежат» и прод, и develop

Типичные причины, когда оба окружения отдают ошибку или 503.

## 1. Health check возвращал 503 из‑за кэша

Раньше `/api/health` возвращал **503**, если была ошибка **любой** проверки, в том числе кэша (KV/Redis). Без кэша приложение работает, но health помечал его как «unhealthy», из‑за чего деплой или мониторинг могли считать, что всё лежит.

**Что сделано:** health считает критичными только **database**, **schema**, **environment**. Если падает только **cache**, ответ остаётся **200** и статус `healthy`. В теле по-прежнему видно `checks.cache.status: 'error'` для диагностики.

## 2. Общая БД или общие env

Если прод и develop (preview) используют **один и тот же** `DATABASE_URL` или один инстанс БД:

- при проблемах с БД «лягут» оба;
- при неверных миграциях или сбое БД — то же самое.

**Что проверить:** в Vercel для Production и Preview заданы нужные `DATABASE_URL`, `TELEGRAM_BOT_TOKEN` и при необходимости разные БД для preview.

## 3. Миграции не применены

Если в БД нет таблиц/колонок, которые ожидает код, health вернёт ошибку по **schema** (и 503 до правки выше).

**Что сделать:** на проде/превью миграции применяются в `postinstall` (`migrate-deploy-with-retry.sh`). Убедиться, что деплой доходит до этого шага и что в логах нет ошибок от `prisma migrate deploy`. При необходимости выполнить миграции вручную.

## 4. Нет или неверные env на Preview

У Preview (develop) могут быть свои переменные. Если для Preview не заданы `DATABASE_URL` или `TELEGRAM_BOT_TOKEN`, health вернёт ошибку по **environment** и 503.

**Что сделать:** в Vercel → Project → Settings → Environment Variables проверить, что нужные переменные добавлены и для **Preview** (и Production) включены галочки нужных окружений.

## 5. Как быстро проверить

- Открыть `https://<твой-домен>/api/health` (прод и превью).
- Смотреть:
  - HTTP-код: 200 — критичные проверки прошли.
  - В JSON: `checks.database`, `checks.schema`, `checks.environment`, `checks.cache` — какая проверка в `error`, по ней и искать причину.
