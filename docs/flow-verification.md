# Проверка последовательности вызовов для полного flow

## Ожидаемый flow:

1. ✅ Пользователь проходит тест (quiz)
2. ✅ Нажимает "Получить план"
3. ✅ Видит лоадер во время генерации плана
4. ✅ Видит план с блюром для оплаты
5. ✅ Видит главную страницу с блюром
6. ✅ Оплачивает
7. ✅ После оплаты все работает - план и главная без блюра
8. ✅ План создан на 28 дней с тремя стадиями
9. ✅ Профиль создан
10. ✅ Средства подобраны

## Проверка компонентов:

### 1. Отправка ответов и создание профиля (`app/(miniapp)/quiz/page.tsx`)

**Файл:** `app/(miniapp)/quiz/page.tsx`

**Функция:** `submitAnswers()` (строка ~1482)

**Последовательность:**
1. Вызывается `api.submitAnswers()` (строка 1683)
2. Проверяется наличие `result?.profile?.id` (строка 1696)
3. Если профиль не создан - показывается ошибка, редирект не происходит
4. Если профиль создан - проверяется `shouldGeneratePlan` (строка 1850)
5. Если нужно генерировать план - вызывается `api.generatePlan()` (строка 1951)
6. После генерации плана - редирект на `/plan` (строка 2456)

**Проблемы:**
- ✅ Проверка профиля добавлена
- ✅ Обработка ошибки 500 (создание профиля) добавлена
- ⚠️ Нужно проверить, что лоадер показывается во время генерации плана

### 2. Генерация плана (`app/api/plan/generate/route.ts`)

**Файл:** `app/api/plan/generate/route.ts` (через `api.generatePlan()`)

**Функция:** `generate28DayPlan()` в `lib/plan-generator.ts`

**Последовательность:**
1. Получается профиль (строка 180)
2. Получаются ответы пользователя (строка 216)
3. Вычисляется классификация профиля (строка 250)
4. Выбирается шаблон плана (строка 300)
5. Подбираются продукты из RecommendationSession или генерируются с нуля (строка 650)
6. Создается план на 28 дней с тремя стадиями (строка 1660)

**Стадии плана:**
- Дни 1-7: `adaptation` (Адаптация)
- Дни 8-21: `active` (Активная фаза)
- Дни 22-28: `support` (Поддержка)

**Проблемы:**
- ✅ План создается на 28 дней
- ✅ Три стадии определены в `lib/plan-types.ts` (строка 47-51)
- ✅ Продукты подбираются из RecommendationSession или генерируются

### 3. Показ лоадера (`app/(miniapp)/quiz/page.tsx`)

**Файл:** `app/(miniapp)/quiz/page.tsx`

**Состояние:** `isSubmitting` (строка 55)

**Проблемы:**
- ⚠️ Нужно проверить, что `isSubmitting` устанавливается в `true` перед генерацией плана
- ⚠️ Нужно проверить, что лоадер показывается во время генерации

### 4. PaymentGate и блюр на странице плана (`app/(miniapp)/plan/plan-client-new.tsx`)

**Файл:** `app/(miniapp)/plan/plan-client-new.tsx`

**Компонент:** `PaymentGate` (строка 14)

**Логика:**
1. Проверяется `payment_first_completed` в localStorage (строка 182)
2. Если оплата не завершена - показывается блюр (строка 70-77)
3. После оплаты - блюр снимается (строка 63-65)

**Проблемы:**
- ✅ PaymentGate работает корректно
- ✅ Блюр показывается для неоплаченных пользователей
- ✅ После оплаты блюр снимается

### 5. Блюр на главной странице (`app/(miniapp)/page.tsx`)

**Файл:** `app/(miniapp)/page.tsx`

**Проблемы:**
- ⚠️ Нужно проверить, есть ли блюр на главной странице для неоплаченных пользователей
- ⚠️ В коде не найдено использование PaymentGate на главной странице

### 6. Снятие блюра после оплаты (`components/PaymentGate.tsx`)

**Файл:** `components/PaymentGate.tsx`

**Логика:**
1. При оплате сохраняется `payment_first_completed` в localStorage (строка 44)
2. `hasPaid` устанавливается в `true` (строка 52)
3. Контент показывается без блюра (строка 63-65)

**Проблемы:**
- ✅ Блюр снимается после оплаты
- ✅ Статус оплаты сохраняется в localStorage

### 7. Создание плана на 28 дней с тремя стадиями (`lib/plan-generator.ts`)

**Файл:** `lib/plan-generator.ts`

**Функция:** `generate28DayPlan()` (строка 172)

**Стадии:**
- Определяются в `lib/plan-types.ts` (строка 47-51)
- Используются при создании плана (строка 2286)

**Проблемы:**
- ✅ План создается на 28 дней
- ✅ Три стадии определены корректно
- ✅ Стадии применяются к каждому дню

### 8. Подбор средств (`lib/plan-generator.ts`)

**Файл:** `lib/plan-generator.ts`

**Логика:**
1. Сначала пытаются использовать продукты из RecommendationSession (строка 650)
2. Если RecommendationSession нет - генерируются продукты с нуля (строка 677)
3. Продукты фильтруются по критериям профиля (строка 710)
4. Продукты сортируются по релевантности (строка 765)

**Проблемы:**
- ✅ Продукты подбираются из RecommendationSession
- ✅ Если RecommendationSession нет - генерируются с нуля
- ✅ Фильтрация по критериям профиля работает

## Выявленные проблемы:

1. ✅ **Лоадер во время генерации плана:** 
   - `isSubmitting` устанавливается в `true` перед вызовом `submitAnswers()` (строка 4575)
   - Кнопка показывает "Отправка..." когда `isSubmitting === true` (строка 4529)
   - ⚠️ НО: Лоадер показывается только на кнопке, отдельного лоадера во время генерации плана нет
   
2. ✅ **Блюр на главной странице:** 
   - ✅ PaymentGate добавлен на главную страницу (`app/(miniapp)/page.tsx`)
   - ✅ Рекомендации обернуты в PaymentGate
   - ✅ Блюр показывается для неоплаченных пользователей
   - ✅ После оплаты блюр снимается

3. ✅ **Остальные компоненты работают корректно**

## Рекомендации:

1. ✅ Лоадер работает на кнопке "Получить план" - показывает "Отправка..." во время отправки
2. ⚠️ **КРИТИЧНО:** Добавить PaymentGate на главную страницу для неоплаченных пользователей
3. Протестировать полный flow от начала до конца

## Детальная проверка flow:

### ✅ 1. Прохождение теста и отправка ответов
- Пользователь проходит все вопросы
- Нажимает "Получить план" (строка 4529)
- `isSubmitting` устанавливается в `true` (строка 4575)
- Вызывается `submitAnswers()` (строка 4580)

### ✅ 2. Создание профиля
- `api.submitAnswers()` вызывается (строка 1683)
- Профиль создается в `/api/questionnaire/answers/route.ts`
- Проверяется наличие `result?.profile?.id` (строка 1696)
- Если профиль не создан - показывается ошибка

### ✅ 3. Генерация плана
- После создания профиля проверяется `shouldGeneratePlan` (строка 1850)
- Вызывается `api.generatePlan()` (строка 1951)
- План генерируется на 28 дней с тремя стадиями

### ✅ 4. Редирект на /plan
- После генерации плана происходит редирект на `/plan` (строка 2456)
- План загружается на странице `/plan`

### ✅ 5. PaymentGate на странице плана
- Проверяется `payment_first_completed` в localStorage (строка 182 в plan-client-new.tsx)
- Если оплата не завершена - показывается блюр (строка 70-77)
- После оплаты - блюр снимается (строка 63-65)

### ⚠️ 6. Блюр на главной странице
- **ПРОБЛЕМА:** PaymentGate не используется на главной странице
- Рекомендации показываются без блюра для неоплаченных пользователей
- **РЕШЕНИЕ:** Нужно обернуть рекомендации в PaymentGate на главной странице

### ✅ 7. Снятие блюра после оплаты
- При оплате сохраняется `payment_first_completed` в localStorage (строка 44 в PaymentGate.tsx)
- `hasPaid` устанавливается в `true` (строка 52)
- Контент показывается без блюра (строка 63-65)

### ✅ 8. План на 28 дней с тремя стадиями
- План создается на 28 дней (строка 1660 в plan-generator.ts)
- Три стадии определены в `lib/plan-types.ts` (строка 47-51):
  - Дни 1-7: `adaptation` (Адаптация)
  - Дни 8-21: `active` (Активная фаза)
  - Дни 22-28: `support` (Поддержка)

### ✅ 9. Подбор средств
- Продукты подбираются из RecommendationSession (строка 650)
- Если RecommendationSession нет - генерируются с нуля (строка 677)
- Продукты фильтруются по критериям профиля (строка 710)






