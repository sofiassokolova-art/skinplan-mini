# Анализ расхождения средств между главной страницей и планом

## Проблемы

1. **Бальзам для губ показывается как увлажняющее средство на главной странице**
2. **Средства на главной не совпадают со средствами в плане**
3. **Периодически показывается экран "профиль отсутствует", хотя при обновлении средства появляются**

## Как работает главная страница

**Файл**: `app/(miniapp)/page.tsx`

1. Загружает рекомендации через `api.getRecommendations()`
2. API `/api/recommendations` возвращает данные из `RecommendationSession`
3. Продукты группируются по шагам (cleanser, toner, serum, moisturizer, spf)
4. Для каждого шага берется первый продукт из массива: `data.steps.moisturizer[0]?.name`

## Как работает план

**Файл**: `app/(miniapp)/plan/page.tsx`

1. Загружает план через `api.getPlan()` или `api.generatePlan()`
2. API `/api/plan` возвращает данные из `Plan28` (JSON поле `planData`)
3. Продукты распределены по дням (28 дней)
4. Каждый день имеет утро/вечер с шагами и productId

## Почему средства не совпадают?

### Проблема 1: Разные источники данных

- **Главная**: Использует `RecommendationSession.products` (массив ID продуктов)
- **План**: Использует `Plan28.planData` (структурированные данные по дням)

### Проблема 2: Группировка продуктов

**В рекомендациях** (app/api/recommendations/route.ts:178-222):
- Продукты из RecommendationSession группируются по нормализованным шагам
- Для каждого шага берется первый продукт на главной странице
- Если шага нет в сессии, добавляются fallback продукты

**В плане** (lib/plan-generator.ts):
- Использует продукты из RecommendationSession (если есть) или все опубликованные
- Распределяет продукты по дням согласно правилам
- Может использовать разные продукты для разных дней

### Проблема 3: Бальзам для губ в moisturizer

**Причина**: 
- В fallback логике (строка 308-313) проверяется `p.category === missingStep`
- Если у продукта category='moisturizer', но step='lip_balm', он может попасть в moisturizer

**Исправление**:
- Добавлена фильтрация, исключающая lip_balm, eye_cream и другие неподходящие продукты
- Проверка теперь использует только `step`, а не `category`

## Исправления

### ✅ Исправление 1: Исключение неподходящих продуктов

**Файл**: `app/api/recommendations/route.ts`

- Добавлена фильтрация при группировке продуктов из RecommendationSession (строки 180-206)
- Добавлена фильтрация в fallback логике (строки 308-329)
- Исключаются: lip_balm, eye_cream, eye_serum, lip_care

### ✅ Исправление 2: Улучшена обработка ошибки 404

**Файл**: `app/(miniapp)/page.tsx`

- При ошибке 404 рекомендации не очищаются, если они уже загружены
- Это предотвращает мигание экрана "профиль отсутствует" при временных ошибках

## Исправления

### ✅ Исправление 3: Синхронизация средств главной страницы с планом

**Файл**: `app/api/recommendations/route.ts`

- **Приоритет использования плана**: Если план (Plan28) существует, используются продукты из первого дня плана для рекомендаций на главной странице
- **Логика**:
  1. Сначала проверяется наличие Plan28 для текущей версии профиля
  2. Если план существует, извлекаются продукты из первого дня (morning + evening)
  3. Продукты группируются по шагам так же, как это делается с RecommendationSession
  4. Это гарантирует полную синхронизацию между главной страницей и планом
- **Fallback**: Если плана нет, используется RecommendationSession (как раньше)

**Результат**:
- Средства на главной странице теперь совпадают со средствами в плане
- Первый день плана используется как источник истины для рекомендаций
- Если план обновляется, рекомендации также синхронизируются

## Рекомендации

### ✅ Выполнено:

- **Использовать продукты из Plan28 для главной страницы** (если план существует)
  - Главная страница теперь показывает продукты из первого дня плана
  - Это гарантирует полную синхронизацию

### Текущее состояние:

- ✅ Главная страница показывает продукты из Plan28 (если план существует)
- ✅ Если план не существует, используется RecommendationSession (обратная совместимость)
- ✅ План показывает продукты из Plan28
- ✅ Средства синхронизированы между главной и планом
