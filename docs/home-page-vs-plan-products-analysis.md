# Анализ расхождения средств между главной страницей и планом

## Проблемы

1. **Бальзам для губ показывается как увлажняющее средство на главной странице**
2. **Средства на главной не совпадают со средствами в плане**
3. **Периодически показывается экран "профиль отсутствует", хотя при обновлении средства появляются**

## Как работает главная страница

**Файл**: `app/(miniapp)/page.tsx`

1. Загружает рекомендации через `api.getRecommendations()`
2. API `/api/recommendations` возвращает данные из `RecommendationSession`
3. Продукты группируются по шагам (cleanser, toner, serum, moisturizer, spf)
4. Для каждого шага берется первый продукт из массива: `data.steps.moisturizer[0]?.name`

## Как работает план

**Файл**: `app/(miniapp)/plan/page.tsx`

1. Загружает план через `api.getPlan()` или `api.generatePlan()`
2. API `/api/plan` возвращает данные из `Plan28` (JSON поле `planData`)
3. Продукты распределены по дням (28 дней)
4. Каждый день имеет утро/вечер с шагами и productId

## Почему средства не совпадают?

### Проблема 1: Разные источники данных

- **Главная**: Использует `RecommendationSession.products` (массив ID продуктов)
- **План**: Использует `Plan28.planData` (структурированные данные по дням)

### Проблема 2: Группировка продуктов

**В рекомендациях** (app/api/recommendations/route.ts:178-222):
- Продукты из RecommendationSession группируются по нормализованным шагам
- Для каждого шага берется первый продукт на главной странице
- Если шага нет в сессии, добавляются fallback продукты

**В плане** (lib/plan-generator.ts):
- Использует продукты из RecommendationSession (если есть) или все опубликованные
- Распределяет продукты по дням согласно правилам
- Может использовать разные продукты для разных дней

### Проблема 3: Бальзам для губ в moisturizer

**Причина**: 
- В fallback логике (строка 308-313) проверяется `p.category === missingStep`
- Если у продукта category='moisturizer', но step='lip_balm', он может попасть в moisturizer

**Исправление**:
- Добавлена фильтрация, исключающая lip_balm, eye_cream и другие неподходящие продукты
- Проверка теперь использует только `step`, а не `category`

## Исправления

### ✅ Исправление 1: Исключение неподходящих продуктов

**Файл**: `app/api/recommendations/route.ts`

- Добавлена фильтрация при группировке продуктов из RecommendationSession (строки 180-206)
- Добавлена фильтрация в fallback логике (строки 308-329)
- Исключаются: lip_balm, eye_cream, eye_serum, lip_care

### ✅ Исправление 2: Улучшена обработка ошибки 404

**Файл**: `app/(miniapp)/page.tsx`

- При ошибке 404 рекомендации не очищаются, если они уже загружены
- Это предотвращает мигание экрана "профиль отсутствует" при временных ошибках

## Рекомендации

### Для синхронизации средств главной и плана:

1. **Использовать продукты из Plan28 для главной страницы** (если план существует)
   - Главная страница должна показывать продукты из первого дня плана
   - Это гарантирует полную синхронизацию

2. **Или синхронизировать RecommendationSession с Plan28**
   - При генерации плана обновлять RecommendationSession продуктами из плана
   - Это более сложный подход, но сохраняет обратную совместимость

### Текущее состояние:

- Главная страница показывает продукты из RecommendationSession
- План показывает продукты из Plan28
- Они могут отличаться, если RecommendationSession был создан отдельно от плана
