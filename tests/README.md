# Автотесты для генерации профиля и подбора средств

## Описание

Автотесты проверяют корректность работы системы генерации профиля кожи после прохождения анкеты и подбора средств на основе правил.

## Установка

Тесты используют Vitest. Установка уже выполнена при добавлении тестов.

## Запуск тестов

### Все тесты
```bash
npm test
```

### Тесты в режиме watch (автоматический перезапуск при изменениях)
```bash
npm run test:watch
```

### Только тесты генерации профиля
```bash
npm run test:profile
```

### Тесты с покрытием кода
```bash
npm run test:coverage
```

## Структура тестов

### `profile-generation.test.ts`

Содержит тесты для:

1. **Генерация профиля**
   - `should create a skin profile after questionnaire submission` - проверяет создание профиля после отправки анкеты
   - `should update profile version on retake` - проверяет обновление версии профиля при перепрохождении
   - `should extract diagnoses and concerns from answers` - проверяет извлечение диагнозов и целей из ответов

2. **Подбор средств**
   - `should create recommendation session with products` - проверяет создание RecommendationSession с продуктами
   - `should select products based on profile characteristics` - проверяет подбор продуктов на основе характеристик профиля

## Требования

- База данных должна быть настроена (переменная окружения `DATABASE_URL`)
- В БД должны быть:
  - Активная анкета (questionnaire) с ID = 1
  - Вопросы с кодами: `gender`, `age`, `skin_type`, `sensitivity`, `diagnoses`, `skin_concerns`
  - Активные правила подбора (recommendationRule) с `isActive = true`
  - Активные продукты (product) с `isActive = true`

## Настройка тестового окружения

Тесты используют отдельного тестового пользователя с `telegramId = 'test-user-profile-generation'`. Все тестовые данные автоматически очищаются перед и после каждого теста.

## Примеры использования

### Запуск конкретного теста
```bash
npm test -- -t "should create a skin profile"
```

### Запуск с подробным выводом
```bash
npm test -- --reporter=verbose
```

### Запуск только упавших тестов
```bash
npm test -- --onlyFailures
```

## Отладка

Если тесты падают, проверьте:

1. Подключение к БД (`DATABASE_URL` в `.env`)
2. Наличие активной анкеты с ID = 1
3. Наличие активных правил и продуктов в БД
4. Логи в консоли для деталей ошибок

## Добавление новых тестов

Для добавления новых тестов:

1. Откройте `tests/profile-generation.test.ts`
2. Добавьте новый `it()` блок в соответствующий `describe()` блок
3. Используйте `createTestUser()` и `createTestAnswers()` для создания тестовых данных
4. Не забудьте очистить данные в `beforeEach()` или `afterEach()`

## Примечания

- Тесты используют реальную БД (не моки)
- Тестовые данные автоматически очищаются
- Тесты изолированы друг от друга
- Каждый тест создает свой набор данных

